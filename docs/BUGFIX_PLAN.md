# 神奇十一人 - 规则修复与优化计划

**创建日期**: 2026-02-11  
**总体进度**: 0/14 (0%)  
**预计完成**: 2026-03-11

---

## 📋 修复优先级分级

| 优先级 | 说明 | 预计时间 |
|--------|------|----------|
| **P0** | 游戏平衡破坏性BUG,立即修复 | 本周内 |
| **P1** | 核心体验问题,影响可玩性 | 2周内 |
| **P2** | 次要优化,提升用户体验 | 1个月内 |
| **P3** | 锦上添花,长期规划 | 后续迭代 |

---

## 🔴 P0: 游戏平衡修复 (本周完成)

### ✅ [P0-1] 射门标记削弱机制
**状态**: ✅ 已完成  
**优先级**: 最高  
**影响**: ⭐⭐⭐⭐⭐ (破坏游戏平衡)  
**预计时间**: 2小时  
**实际时间**: 1.5小时  
**完成日期**: 2026-02-11

#### 问题描述
桌游规则要求:每次射门后,射门标记翻到背面,削弱基础攻击力。
当前实现:只累加计数器,不减少攻击力→球员可无限全力射门

#### 修复内容 ✅
1. ✅ 修改 `calculateAttackPower` 函数,新增 `usedShotMarkers` 参数
2. ✅ 实现公式: `effectiveAttack = max(0, baseAttack - shotMarkers)`
3. ✅ 更新 `performShot` 函数,在射门前获取当前标记数
4. ✅ 优化UI显示:射门标记显示"-1/-2/-3"数字
5. ✅ 射门按钮显示当前有效攻击力

#### 修改文件
- `src/game/gameLogic.ts` (Line 508-518, 686-700)
- `src/components/GameField.tsx` (Line 223-253)

#### 验收标准 ✅
- [x] 首次射门:全攻击力
- [x] 第2次射门:攻击力 -1
- [x] 第3次射门:攻击力 -2
- [x] 第4次射门:攻击力 -3 (至少保留0)
- [x] UI正确显示剩余射门标记和有效攻击力

#### 测试说明
1. 放置一张3攻击力的卡牌
2. 第1次射门:显示"⚽ 3"
3. 第2次射门:显示"⚽ 2" + 右上角1个黑色标记"-1"
4. 第3次射门:显示"⚽ 1" + 右上角2个黑色标记"-1/-2"
5. 第4次射门:显示"⚽ 0" + 右上角3个黑色标记"-1/-2/-3"

---

### ✅ [P0-2] 战术图标连接验证与可视化
**状态**: ✅ 已完成  
**优先级**: 最高  
**影响**: ⭐⭐⭐⭐ (影响卡牌放置合法性)  
**预计时间**: 3小时  
**实际时间**: 2小时  
**完成日期**: 2026-02-11

#### 问题描述
桌游规则:卡牌必须与场上至少1张卡匹配战术图标(半圆连接)
当前实现:只验证物理相邻,但缺少可视化反馈

#### 修复内容 ✅
1. ✅ 创建 `TacticalConnections.tsx` 组件显示战术连接
2. ✅ 实现半圆图标匹配逻辑 (`MATCHING_POSITIONS`)
3. ✅ 添加SVG曲线连接相邻卡牌
4. ✅ 连接线显示图标类型+颜色
5. ✅ 添加动画效果(虚线流动+发光)

#### 新增文件
- `src/components/TacticalConnections.tsx` (237行)

#### 修改文件
- `src/components/GameField.tsx` (Line 1-8, 97-100, 113, 265-273)

#### 验收标准 ✅
- [x] 相邻卡牌的匹配图标显示连接线
- [x] 不同图标类型显示不同颜色
- [x] 连接线为曲线,视觉优雅
- [x] 线条有发光+动画效果
- [x] 玩家和AI半场分别显示

#### 视觉效果
- 攻击图标(⚔): 红色连接线 (#E53935)
- 防守图标(🛡): 蓝色连接线 (#1E88E5)
- 传球图标(↔): 绿色连接线 (#43A047)
- 逼抢图标(⚡): 橙色连接线 (#FB8C00)
- 突破图标(💨): 紫色连接线 (#9C27B0)

---

## 🟠 P1: 核心体验优化 (2周完成)

### ✅ [P1-1] AI决策系统增强
**状态**: 🔲 待实现  
**优先级**: 高  
**影响**: ⭐⭐⭐⭐ (影响单人游戏体验)  
**预计时间**: 8小时

#### 问题描述
当前AI完全随机,没有战术思考
需要实现基础的局势评估和决策树

#### 修复文件
- `src/ai/strategy.ts` (新建)
- `src/game/gameLogic.ts` - AI行动逻辑

#### 实现步骤
1. 创建 `evaluateGameState` 函数(比分、控制、手牌)
2. 实现 `chooseBestCard` - 卡牌选择策略
   - 落后时优先进攻卡
   - 领先时优先防守卡
   - 考虑战术图标匹配度
3. 实现 `chooseBestPosition` - 位置选择策略
   - 最大化协同连接
   - 靠近对方球门(进攻时)
   - 封锁射门路径(防守时)
4. 实现 `decideAction` - 行动决策
   - 何时射门(攻击力>防守力+2)
   - 何时传球(积累协同)
   - 何时使用协同卡
5. 添加难度等级(简单/普通/困难)

#### 验收标准
- [ ] AI根据局势选择合理卡牌
- [ ] AI优先放置在高协同位置
- [ ] AI在优势时果断射门
- [ ] AI在劣势时积极防守
- [ ] 3种难度AI表现明显不同

---

### ⏸️ [P1-2] 射程指示器
**状态**: ⏸️ 暂缓(基础已具备)  
**优先级**: 高  
**影响**: ⭐⭐⭐ (提升可用性)  
**预计时间**: 2小时  
**说明**: 代码已有 `onCardMouseEnter` 接口,可快速实现。暂时跳过,优先完成更重要的P1-3/P1-4。

#### 实现内容 (待补充)
1. 鼠标悬停射手卡牌时,高亮显示可射门区域
2. 显示预览攻击力 vs 防守力
3. 区分必进(绿色)、可能(黄色)、困难(红色)

---

### ✅ [P1-3] 阶段提示优化
**状态**: ✅ 已完成  
**优先级**: 中高  
**影响**: ⭐⭐⭐ (减少困惑)  
**预计时间**: 2小时  
**实际时间**: 0.5小时  
**完成日期**: 2026-02-11

#### 实现内容 ✅
1. ✅ 阶段横幅添加副标题说明
2. ✅ 优化文案,告诉玩家可以做什么
3. ✅ 区分玩家/AI回合提示

#### 修改文件
- `src/components/PhaseBanner.tsx` (新增subtitle参数)
- `src/components/GameBoard.tsx` (优化阶段提示文案)

#### 优化后的提示
| 阶段 | 主标题 | 副标题 |
|------|--------|--------|
| 战术阶段 | TACTICAL PHASE | Choose Team Action: Pass or Press |
| 行动阶段(玩家) | ACTION PHASE | Place a Card or Attempt a Shot |
| 行动阶段(AI) | ACTION PHASE | AI is Thinking... |
| 射门阶段 | BATTLE PHASE | Shot Attempt in Progress! |
| 中场休息 | HALF TIME | Make Substitutions and Prepare for 2nd Half |
| 加时赛 | EXTRA TIME | Sudden Death! Next Goal Wins! |
| 伤停补时 | STOPPAGE TIME | Synergy Deck Reshuffled! |

---

### ✅ [P1-4] 交互反馈完善
**状态**: 🔲 待实现  
**优先级**: 中  
**影响**: ⭐⭐⭐ (提升体验)  
**预计时间**: 3小时

#### 实现内容
1. **Toast消息系统**
   - 进球:"⚽ 进球! +1分"
   - 点球:"⚠️ 犯规! 对方获得点球"
   - 获得控制:"🎯 获得控制标记"
   - 协同卡:"✨ 获得协同卡"
2. **卡牌拖拽预览**
   - 拖拽时半透明显示卡牌
   - 有效位置绿框,无效位置红框
3. **动画效果**
   - 卡牌放置:缩放弹出效果
   - 进球:球门闪光动画
   - 获得控制:标记飞入动画

#### 验收标准
- [ ] 所有关键事件都有Toast提示
- [ ] 拖拽时实时显示放置合法性
- [ ] 动画流畅不卡顿(60fps)
- [ ] 支持3秒内自动消失

---

## 🟡 P2: 体验优化 (1个月完成)

### ✅ [P2-1] 卡牌放置规则严格化
**状态**: 🔲 待优化  
**优先级**: 中  
**影响**: ⭐⭐ (规则一致性)  
**预计时间**: 2小时

#### 优化内容
1. 禁止在已占用的slot放置
2. 强制执行"必须匹配图标"规则(除首张外)
3. 添加放置撤销功能(本回合内)

---

### ✅ [P2-2] 协同卡手牌满时提示
**状态**: 🔲 待实现  
**优先级**: 中  
**影响**: ⭐⭐ (防止卡牌丢失)  
**预计时间**: 1小时

#### 实现内容
1. 手牌达到上限时,显示警告Toast
2. 自动弹出协同卡选择面板
3. 强制使用1张后才能继续

---

### ✅ [P2-3] 移动端适配
**状态**: 🔲 待优化  
**优先级**: 中  
**影响**: ⭐⭐⭐ (移动端体验)  
**预计时间**: 6小时

#### 优化内容
1. 触摸拖拽优化(长按触发)
2. 按钮尺寸增大(最小44x44px)
3. 字体大小响应式调整
4. 横屏布局优化
5. 虚拟键盘避让

#### 验收标准
- [ ] iPhone SE (375px) 完美适配
- [ ] iPad (768px) 完美适配
- [ ] 安卓横屏模式正常
- [ ] 触摸操作流畅无误触

---

### ✅ [P2-4] 历史记录与回放
**状态**: 🔲 待实现  
**优先级**: 中低  
**影响**: ⭐⭐ (复盘价值)  
**预计时间**: 4小时

#### 实现内容
1. 记录所有游戏事件(JSON格式)
2. 添加"历史记录"侧边栏
3. 支持跳转到任意回合查看
4. 支持导出游戏录像

---

## 🟢 P3: 美术与音效 (后续迭代)

### ✅ [P3-1] 音效系统
**状态**: 🔲 待实现  
**优先级**: 低  
**影响**: ⭐⭐ (氛围感)  
**预计时间**: 3小时

#### 音效列表
- 卡牌放置:"啪"
- 进球:"欢呼声"
- 点球:"哨声"
- 回合切换:"叮"
- 背景音乐:轻快BGM

---

### ✅ [P3-2] 视觉特效
**状态**: 🔲 待实现  
**优先级**: 低  
**影响**: ⭐⭐ (表现力)  
**预计时间**: 4小时

#### 特效列表
- 进球:烟花粒子效果
- 获得控制:光环闪烁
- 战术连接:脉冲光线
- 铲球:碰撞星星

---

### ✅ [P3-3] 美术资源替换
**状态**: 🔲 待设计  
**优先级**: 低  
**影响**: ⭐⭐ (视觉品质)  
**预计时间**: 16小时(需设计师)

#### 资源列表
- 卡牌背景:高清纹理
- 球员头像:统一风格插画
- 场地纹理:草地细节
- 图标重绘:矢量SVG

---

## 📊 进度跟踪表

| 任务编号 | 任务名称 | 优先级 | 状态 | 预计时间 | 实际时间 | 负责人 | 完成日期 |
|---------|---------|-------|------|---------|---------|--------|---------|
| P0-1 | 射门标记削弱 | P0 | ✅ 已完成 | 2h | 1.5h | AI | 2026-02-11 |
| P0-2 | 战术图标连接验证 | P0 | ✅ 已完成 | 3h | 2h | AI | 2026-02-11 |
| **E2E** | **E2E自动化测试** | **P0** | ✅ **已完成** | **4h** | **2h** | **AI** | **2026-02-11** |
| P1-1 | AI决策系统增强 | P1 | 🔲 待实现 | 8h | - | - | - |
| P1-2 | 射程指示器 | P1 | ⏸️ 暂缓 | 2h | - | - | - |
| P1-3 | 阶段提示优化 | P1 | ✅ 已完成 | 2h | 0.5h | AI | 2026-02-11 |
| P1-4 | 交互反馈完善 | P1 | 🔲 待实现 | 3h | - | - | - |
| P2-1 | 卡牌放置规则严格化 | P2 | 🔲 待优化 | 2h | - | - | - |
| P2-2 | 协同卡手牌满提示 | P2 | 🔲 待实现 | 1h | - | - | - |
| P2-3 | 移动端适配 | P2 | 🔲 待优化 | 6h | - | - | - |
| P2-4 | 历史记录与回放 | P2 | 🔲 待实现 | 4h | - | - | - |
| P3-1 | 音效系统 | P3 | 🔲 待实现 | 3h | - | - | - |
| P3-2 | 视觉特效 | P3 | 🔲 待实现 | 4h | - | - | - |
| P3-3 | 美术资源替换 | P3 | 🔲 待设计 | 16h | - | - | - |

**总计**: 60小时 (约7.5个工作日)  
**已完成**: 4/14 任务 (28.6%)  
**累计耗时**: 6小时  
**P0阶段**: ✅ 已完成 (3/3包含E2E)  
**P1阶段**: 🔄 进行中 (1/4完成, 1暂缓)

---

## 🚀 本周计划 (2026-02-11 ~ 2026-02-17)

### 周一 (2/11)
- [x] 完成规则分析文档
- [x] **完成 P0-1: 射门标记削弱** ✅
- [x] **完成 P0-2: 战术图标连接** ✅
- [ ] **开始 P1-1: AI决策系统**

### 周二 (2/12)
- [ ] 完成 P1-1: AI决策系统
- [ ] **开始 P1-2/P1-3: UI优化**

### 周三 (2/13)
- [ ] 完成 P1-2: 射程指示器
- [ ] 完成 P1-3: 阶段提示优化

### 周四-周五 (2/14-15)
- [ ] **开始 P1-4: 交互反馈完善**
- [ ] 完成P1所有任务

### 周末 (2/16-17)
- [ ] 代码review + 测试
- [ ] 周总结与下周计划

---

## 📝 开发规范

### Git提交规范
```
[P0-1] feat: 实现射门标记削弱机制
[P0-2] fix: 修复战术图标连接验证
[P1-1] feat: 新增AI决策系统
[P2-3] style: 移动端布局优化
```

### 测试规范
每个P0/P1任务必须包含:
- [ ] 单元测试(核心逻辑)
- [ ] 手工测试清单
- [ ] 边界情况测试
- [ ] 回归测试(不影响其他功能)

### 文档更新
修复完成后更新:
- `docs/RULE_IMPLEMENTATION_ANALYSIS.md` (规则实现状态)
- `GAME_MANUAL.md` (用户手册)
- `docs/BUGFIX_PLAN.md` (本文档进度)

---

## 🎯 下一步行动

**立即开始**: [P0-1] 射门标记削弱机制  
**预计耗时**: 2小时  
**涉及文件**:
- `src/game/gameLogic.ts`
- `src/components/GameBoard.tsx`

准备好了吗?让我们开始修复! 🚀
